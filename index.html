<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MODULO MANUTENZIONE</title>
<style>
  * {
    box-sizing: border-box;
  }
  
  body { 
    font-family: Roboto, Arial, sans-serif; 
    margin: 0; 
    padding: 0; 
    display: flex; 
    justify-content: center; 
    background: #e6f0fa; 
    font-size: 16px; 
  }
  
  #formWrapper { 
    width: 100%; 
    max-width: 480px; 
    padding: 10px 20px; 
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 2px 12px rgba(0,0,0,0.1); 
    margin: 20px auto;
  }
  
  h2 {
    text-align: center; 
    font-size: 22px; 
    margin-bottom: 10px;
  } 
  
  h4 {
    text-align: center; 
    font-size: 16px; 
    color: #555; 
    margin: 5px 0; 
    font-weight: normal;
  }
  
  label {
    display: block; 
    font-weight: bold; 
    margin-top: 18px; 
    font-size: 16px;
    text-align: center;
  }
  
  input, select, textarea {
    width: 100%; 
    padding: 16px 14px; 
    margin-top: 5px; 
    font-size: 20px; 
    line-height: 1.4; 
    border-radius: 8px; 
    border: 1px solid #ccc; 
    display: block;
    text-align: center;
  }
  
  .button-group {
    display: flex; 
    flex-wrap: wrap;
    gap: 12px; 
    margin-top: 10px; 
    justify-content: center;
  }
  
  .button-group input[type="radio"] {
    display: none;
  }
  
  .button-group label {
    flex: 1 1 calc(50% - 6px);
    min-width: 140px;
    padding: 16px 20px; 
    background: #f0f0f0; 
    border: 2px solid #ddd; 
    border-radius: 10px; 
    text-align: center; 
    cursor: pointer; 
    font-weight: 600; 
    font-size: 18px; 
    transition: all 0.3s ease; 
    margin: 0;
  }
  
  .button-group input[type="radio"]:checked + label {
    background: #1a73e8; 
    color: white; 
    border-color: #1a73e8; 
    box-shadow: 0 4px 12px rgba(26,115,232,0.3);
  }
  
  .button-group label:hover {
    transform: translateY(-2px); 
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .checkbox-group {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    text-align: left;
    margin: 0;
  }

  .checkbox-group input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin: 0;
    flex-shrink: 0;
  }

  #altroTesto {
    display: none;
    width: 100%;
    padding: 12px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    text-align: center;
  }

  #alertObbligatorio {
    background: #ffe6e6;
    border: 2px solid red;
    border-radius: 8px;
    padding: 12px;
    margin-top: 20px;
    color: red;
    font-weight: bold;
    font-size: 15px;
    text-align: center;
    width: 100%;
  }

  #prenota {
    width: 100%;
    padding: 18px;
    margin-top: 20px;
    margin-bottom: 20px;
    font-size: 20px;
    font-weight: bold;
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: block;
  }

  #prenota:hover:not(:disabled) {
    background: #1557b0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(26,115,232,0.3);
  }

  #prenota:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  #successOverlay, #errorOverlay {
    display: none; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    background: rgba(255,255,255,0.98); 
    z-index: 100; 
    text-align: center; 
    padding: 40px 30px; 
    font-size: 18px; 
    font-weight: bold; 
    max-width: 90%; 
    border-radius: 12px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    line-height: 1.6;
  }

  #successOverlay {
    color: #2e7d32;
    border: 3px solid #4caf50;
  }

  #errorOverlay {
    color: #c62828;
    border: 3px solid #f44336;
  }
  
  #loadingOverlay, #sendingOverlay {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: #e6f0fa; 
    z-index: 200; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center;
  }

  #sendingOverlay {
    display: none;
  }
  
  .spinner {
    border: 8px solid #f3f3f3; 
    border-top: 8px solid #1a73e8; 
    border-radius: 50%; 
    width: 60px; 
    height: 60px; 
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); } 
    100% { transform: rotate(360deg); }
  }
  
  #loadingOverlay p, #sendingOverlay p {
    margin-top: 20px; 
    font-size: 18px; 
    color: #555; 
    font-weight: bold;
    text-align: center;
    padding: 0 20px;
  }

  input[type="text"]#targa {
    text-transform: uppercase;
  }
</style>
</head>
<body onload="init()">
  <!-- Schermata di caricamento iniziale -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Caricamento modulo in corso...</p>
  </div>

  <!-- Schermata invio dati -->
  <div id="sendingOverlay">
    <div class="spinner"></div>
    <p>Invio dati in corso...<br>NON CHIUDERE LA PAGINA<br>Attendere...</p>
  </div>

  <div id="formWrapper" style="display:none;">
    <h2>MODULO PRENOTAZIONE APPUNTAMENTO MANUTENZIONE AUTO</h2>
    <h4>PALAMINI AUTO, Via San Luigi 1/A, Cesano Maderno</h4>
    <h4>Si ricorda di rispettare l'orario scelto, grazie.</h4>

    <form id="prenotaForm" oninput="aggiornaStatoPrenota(); return false;">
      <label>TIPOLOGIA CLIENTE:</label>
      <div class="button-group">
        <input type="radio" name="tipologiacliente" value="PRIVATO" id="tipPrivato" onchange="aggiornaAvvisiETipologia()">
        <label for="tipPrivato">PRIVATO</label>
        
        <input type="radio" name="tipologiacliente" value="ARVAL" id="tipArval" onchange="aggiornaAvvisiETipologia()">
        <label for="tipArval">ARVAL</label>

        <input type="radio" name="tipologiacliente" value="UNIPOLRENTAL" id="tipUnipol" onchange="aggiornaAvvisiETipologia()">
        <label for="tipUnipol">UNIPOLRENTAL</label>

        <input type="radio" name="tipologiacliente" value="ALTRO NOLEGGIO" id="tipAltri" onchange="aggiornaAvvisiETipologia()">
        <label for="tipAltri">ALTRO NOLEGGIO</label>
      </div>
      <div id="avvisoNoleggio" style="display:none; color:red; font-size:14px; margin-top:8px; text-align:center;">
        Nel campo nome e cognome indicare anche il nome del noleggio scritto sul libretto di circolazione
      </div>

      <label>TARGA AUTO:</label>
      <input type="text" id="targa" maxlength="7" onchange="aggiornaStatoPrenota()" style="text-transform:uppercase;">

      <label>KM AUTO:</label>
      <input type="text" inputmode="numeric" id="km" onchange="aggiornaStatoPrenota()">
          
      <label>MARCA E MODELLO AUTO:</label>
      <input type="text" id="marcaModello" onchange="aggiornaStatoPrenota()">
      <div style="color: #999; font-size: 13px; margin-top: 5px; text-align: center;">
      MARCA E MODELLO AUTO, ALIMENTAZIONE E TIPOLOGIA CAMBIO<br>
      (Esempio: Fiat Panda Benzina Cambio Manuale)
      </div>
         
      <label>NOME E COGNOME:</label>
      <input type="text" id="nomeCognome" onchange="aggiornaStatoPrenota()">

      <label>EMAIL:</label>
      <input type="email" id="email" inputmode="email" autocomplete="email" onchange="aggiornaStatoPrenota()">

      <label>CONTATTO TELEFONICO:</label>
      <input type="text" id="telefono" inputmode="tel" autocomplete="tel" onchange="aggiornaStatoPrenota()">

      <label style="margin-top:20px;">LAVORAZIONE RICHIESTA:</label>

      <div class="checkbox-group">
        <label><input type="checkbox" name="lavorazione" value="Tagliando" onchange="aggiornaStatoPrenota()"> Tagliando e/o cambio olio</label>
        <label><input type="checkbox" name="lavorazione" value="Spazzole" onchange="aggiornaStatoPrenota()"> Spazzole tergicristallo</label>
        <label><input type="checkbox" id="altroCheck" onchange="aggiornaStatoPrenota()"> Altro:</label>
        <input type="text" id="altroTesto" placeholder="Specifica qui..." oninput="aggiornaStatoPrenota()" />
      </div>

     <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 12px; margin-top: 15px; color: #e65100; font-size: 14px; text-align: center;">
    ⚠️ È indicato l'orario di accettazione auto, per la manutenzione ordinaria è stimata la riconsegna del veicolo in 7 ore lavorative.<br>
     Avviseremo comunque tramite un messaggio WhatsApp quando la macchina sarà pronta per la riconsegna.
    </div>

      <label>DATA APPUNTAMENTO:</label>
      <select id="dataAppuntamento" onchange="aggiornaStatoPrenota()">
        <option value="">Seleziona...</option>
      </select>

      <div id="alertObbligatorio">❌ Attenzione: tutti i campi sono obbligatori</div>
      
      <button type="button" id="prenota" onclick="invia()" disabled>Prenota</button>
    </form>
  </div>

  <div id="successOverlay">
    ✅ MODULO INVIATO CORRETTAMENTE<br><br>
    Si ricorda che è obbligatorio presentarsi in officina il giorno dell'appuntamento con la mail appena ricevuta (controllare anche lo SPAM).<br><br>
    Grazie.
  </div>

  <div id="errorOverlay">
    ❌ ERRORE NELL'INVIO DEI DATI<br><br>
    Si è verificato un problema durante l'invio della prenotazione.<br><br>
    Ti preghiamo di riprovare o contattarci telefonicamente.
  </div>

<script>
const altroCheck = document.getElementById('altroCheck');
const altroTesto = document.getElementById('altroTesto');

altroCheck.addEventListener('change', () => {
  if (altroCheck.checked) {
    altroTesto.style.display = 'block';
    altroTesto.focus();
  } else {
    altroTesto.style.display = 'none';
    altroTesto.value = '';
  }
});
  
const API_URL = 'https://script.google.com/macros/s/AKfycbw31COz80pY7XXoOqZK_klwhHwnFHushOQf3G7hVbZpXOcI5mxmofw0re3QRITO0ubdbg/exec';

let dateFlotte = [];
let datePrivati = [];

function aggiornaAvvisiETipologia() {
  const avviso = document.getElementById('avvisoNoleggio');
  const tipologia = document.querySelector('input[name="tipologiacliente"]:checked')?.value;
  
  if (tipologia === 'ALTRO NOLEGGIO') {
    avviso.style.display = 'block';
  } else {
    avviso.style.display = 'none';
  }
  
  popolaDateDropdown();
  aggiornaStatoPrenota();
}

async function init(){
  const loadingScreen = document.getElementById("loadingOverlay");
  const formWrapper = document.getElementById("formWrapper");
  
  try {
    const response = await fetch(API_URL);
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    dateFlotte = data.dateFlotte || [];
    datePrivati = data.datePrivati || [];
    
    popolaDateDropdown();
    
    loadingScreen.style.display = "none";
    formWrapper.style.display = "block";
    
  } catch(error) {
    alert('Errore nel caricamento dei dati. Riprova più tardi.');
    loadingScreen.querySelector('p').textContent = 'Errore di caricamento. Ricarica la pagina.';
  }

  aggiornaStatoPrenota();
}

function popolaDateDropdown() {
  const select = document.getElementById("dataAppuntamento");
  const tipologia = document.querySelector('input[name="tipologiacliente"]:checked')?.value;
  
  select.innerHTML = '<option value="">Seleziona...</option>';
  
  let dateToShow = [];
  
  if (tipologia === 'PRIVATO') {
    dateToShow = unisciEOrdinaDate(dateFlotte, datePrivati);
  } else if (tipologia === 'ARVAL' || tipologia === 'UNIPOLRENTAL' || tipologia === 'ALTRO NOLEGGIO') {
    dateToShow = ordinaDate(dateFlotte);
  } else {
    return;
  }
  
  dateToShow.forEach(d => {
    const option = document.createElement("option");
    option.value = d;
    option.textContent = d;
    select.appendChild(option);
  });
}

function parseDateString(str) {
  if (!str) return null;
  const months = {
    "gennaio": 0, "febbraio": 1, "marzo": 2, "aprile": 3, "maggio": 4, "giugno": 5,
    "luglio": 6, "agosto": 7, "settembre": 8, "ottobre": 9, "novembre": 10, "dicembre": 11
  };
  
  const parts = str.toLowerCase().split(" ");
  if (parts.length < 4) return null;
  
  const day = parseInt(parts[1]);
  const month = months[parts[2]];
  const now = new Date();
  const year = now.getFullYear();
  const [hours, minutes] = parts[3].split(":").map(Number);
  
  return new Date(year, month, day, hours, minutes);
}

function ordinaDate(dateArray) {
  const datesWithObj = dateArray.map(d => ({
    text: d,
    date: parseDateString(d)
  })).filter(item => item.date !== null);
  
  datesWithObj.sort((a, b) => a.date - b.date);
  
  return datesWithObj.map(item => item.text);
}

function unisciEOrdinaDate(array1, array2) {
  const allDates = [...array1, ...array2];
  return ordinaDate(allDates);
}

function aggiornaStatoPrenota(){
  const btn = document.getElementById("prenota");
  const targaOk = document.getElementById("targa").value.trim();
  const dataOk = document.getElementById("dataAppuntamento").value.trim() !== "";
  const telOk = document.getElementById("telefono").value.trim() !== "";
  const emailOk = document.getElementById("email").value.trim() !== "";
  const nomeOk = document.getElementById("nomeCognome").value.trim() !== "";
  const kmOk = document.getElementById("km").value.trim() !== "";
  const modelloOk = document.getElementById("marcaModello").value.trim() !== "";
  const tipologiaOk = document.querySelector('input[name="tipologiacliente"]:checked') !== null;
  
  const lavorazioneOk = document.querySelectorAll('input[name="lavorazione"]:checked').length > 0 || 
                        (altroCheck.checked && altroTesto.value.trim() !== "");

  const tuttiCampiOk = targaOk && dataOk && telOk && emailOk && nomeOk && kmOk && modelloOk && lavorazioneOk && tipologiaOk;
  
  btn.disabled = !tuttiCampiOk;
  document.getElementById("alertObbligatorio").style.display = tuttiCampiOk ? "none" : "block";
}

async function invia(){
  const btn = document.getElementById("prenota");
  btn.disabled = true;
  
  document.getElementById("sendingOverlay").style.display = "flex";

  const lavorazioniSelezionate = [];
  document.querySelectorAll('input[name="lavorazione"]:checked').forEach(cb => {
    lavorazioniSelezionate.push(cb.value);
  });
  
  if (altroCheck.checked && altroTesto.value.trim() !== "") {
    lavorazioniSelezionate.push("Altro: " + altroTesto.value.trim());
  }

  const dati = {
    tipologiacliente: document.querySelector('input[name="tipologiacliente"]:checked')?.value || "",
    targa: document.getElementById("targa").value.trim().toUpperCase(),
    km: document.getElementById("km").value.trim(),
    marcaModello: document.getElementById("marcaModello").value.trim(),
    nomeCognome: document.getElementById("nomeCognome").value.trim(),
    email: document.getElementById("email").value.trim(),
    telefono: document.getElementById("telefono").value.trim(),
    lavorazione: lavorazioniSelezionate.join(", "),
    dataAppuntamento: document.getElementById("dataAppuntamento").value
  };

  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'salvaPrenotazione', dati: dati })
    });

    const result = await response.json();

    document.getElementById("sendingOverlay").style.display = "none";

    if (result.success) {
      document.getElementById("formWrapper").style.display = "none";
      const overlay = document.getElementById("successOverlay");
      overlay.style.display = "block";
      overlay.scrollIntoView({behavior:"smooth", block:"center"});
    } else {
      const errorOverlay = document.getElementById("errorOverlay");
      errorOverlay.style.display = "block";
      errorOverlay.scrollIntoView({behavior:"smooth", block:"center"});
      btn.disabled = false;
    }
  } catch(error) {
    document.getElementById("sendingOverlay").style.display = "none";
    const errorOverlay = document.getElementById("errorOverlay");
    errorOverlay.style.display = "block";
    errorOverlay.scrollIntoView({behavior:"smooth", block:"center"});
    btn.disabled = false;
  }
}
</script>
</body>
</html>
