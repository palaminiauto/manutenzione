<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MODULO MANUTENZIONE</title>
<style>
  body { font-family: Roboto, Arial; margin:0; padding:0; display:flex; justify-content:center; background:#e6f0fa; font-size:16px; }
  #formWrapper { width:100%; max-width:480px; padding:10px 20px; background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.1); margin:20px 0; }
  h2{text-align:center; font-size:22px; margin-bottom:10px;} 
  h4{text-align:center; font-size:16px; color:#555; margin:5px 0; font-weight:normal;}
  label{display:block; font-weight:bold; margin-top:18px; font-size:16px;text-align: center;}
  input,select,textarea{width:100%; padding:16px 14px; margin-top:5px; font-size:20px; line-height:1.4; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;display: block;text-align: center;}
  
  /* STILE BOTTONI TIPOLOGIA CLIENTE */
  .button-group{display:flex; gap:12px; margin-top:10px; justify-content:center;}
  .button-group input[type="radio"]{display:none;}
  .button-group label{flex:1; padding:16px 20px; background:#f0f0f0; border:2px solid #ddd; border-radius:10px; text-align:center; cursor:pointer; font-weight:600; font-size:18px; transition:all 0.3s ease; margin:0;}
  .button-group input[type="radio"]:checked + label{background:#1a73e8; color:white; border-color:#1a73e8; box-shadow:0 4px 12px rgba(26,115,232,0.3);}
  .button-group label:hover{transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.1);}
  
  #successOverlay{display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,0.95); z-index:100; text-align:center; padding:50px 20px; font-size:22px; font-weight:bold; color:green; max-width:90%; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2);}
  #loadingOverlay{position:fixed; top:0; left:0; width:100%; height:100%; background:#e6f0fa; z-index:200; display:flex; flex-direction:column; justify-content:center; align-items:center;}
  .spinner{border:8px solid #f3f3f3; border-top:8px solid #1a73e8; border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite;}
  @keyframes spin{0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);}}
  #loadingOverlay p{margin-top:20px; font-size:18px; color:#555; font-weight:bold;}
  
  .checkbox-group {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    text-align: left;
    margin: 0;
  }

  .checkbox-group input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin: 0;
    flex-shrink: 0;
  }

  #altroTesto {
    display: none;
    width: 100%;
    padding: 12px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    box-sizing: border-box;
    text-align: center;
  }

  /* ALERT E BOTTONE */
  #alertObbligatorio {
    background: #ffe6e6;
    border: 2px solid red;
    border-radius: 8px;
    padding: 12px;
    margin-top: 20px;
    color: red;
    font-weight: bold;
    font-size: 15px;
    text-align: center;
  }

  #prenota {
    width: 100%;
    padding: 18px;
    margin-top: 20px;
    font-size: 20px;
    font-weight: bold;
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: block;
  }

  #prenota:hover:not(:disabled) {
    background: #1557b0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(26,115,232,0.3);
  }

  #prenota:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
</style>
</head>
<body onload="init()">
  <!-- Schermata di caricamento -->
 <div id="loadingOverlay">
  <div class="spinner"></div>
  <p>Caricamento in corso...</p>
</div>

  <div id="formWrapper" style="display:none;">
    <h2>MODULO PRENOTAZIONE APPUNTAMENTO MANUTENZIONE AUTO</h2>
    <h4>PALAMINI AUTO, Via San Luigi 1/A, Cesano Maderno</h4>
    <h4>Si ricorda di rispettare l'orario scelto, grazie.</h4>

    <form id="prenotaForm" oninput="aggiornaStatoPrenota(); return false;">
      <label>TIPOLOGIA CLIENTE:</label>
      <div class="button-group">
        <input type="radio" name="tipologiacliente" value="PRIVATO" id="tipPrivato" onchange="aggiornaVisibilita()">
        <label for="tipPrivato">PRIVATO</label>
        
        <input type="radio" name="tipologiacliente" value="ARVAL" id="tipArval" onchange="aggiornaVisibilita()">
        <label for="tipNoleggi">ARVAL</label>

        <input type="radio" name="tipologiacliente" value="UNIPOLRENTAL" id="tipUnipol" onchange="aggiornaVisibilita()">
        <label for="tipNoleggi">UNIPOLRENTAL</label>

        <input type="radio" name="tipologiacliente" value="ALTRO NOLEGGIO" id="tipAltri" onchange="aggiornaVisibilita()">
        <label for="tipNoleggi">ALTRO NOLEGGIO</label>
      </div>

        <label>TARGA AUTO:</label>
        <input type="text" id="targa" maxlength="7" oninput="checkTargaInput(this)">
        <div id="targaMsg">✏️ Inserisci la targa (7 caratteri)</div>

        <label>KM AUTO:</label>
        <input type="text" id="km">
            
        <label>MARCA E MODELLO AUTO:</label>
        <input type="text" id="marcaModello">
           
        <label>NOME E COGNOME:</label>
        <input type="text" id="nomeCognome" onchange="aggiornaStatoPrenota()">

        <label>EMAIL:</label>
        <input type="email" id="email" inputmode="email" autocomplete="email" onchange="aggiornaStatoPrenota()">

        <label>CONTATTO TELEFONICO:</label>
        <input type="text" id="telefono" inputmode="tel" autocomplete="tel" onchange="aggiornaStatoPrenota()">

        <label style="display:block; text-align:center; font-weight:bold; margin-top:20px;">LAVORAZIONE RICHIESTA:</label>

<div class="checkbox-group">
  <label><input type="checkbox" name="lavorazione" value="Tagliando"> Tagliando e/o cambio olio</label>
  <label><input type="checkbox" name="lavorazione" value="Spazzole"> Spazzole tergicristallo</label>
  <label><input type="checkbox" name="lavorazione" value="AdBlue"> AdBlue (gratuito per Unipol Rental)</label>
  <label><input type="checkbox" id="altroCheck"> Altro:</label>
  <input type="text" id="altroTesto" placeholder="Specifica qui..." />
</div>

      

        <label>DATA APPUNTAMENTO:</label>
        <select id="dataAppuntamento" onchange="aggiornaStatoPrenota()">
          <option value="">Seleziona...</option>
        </select>
      </div>

      <div style="background:#ffe6e6; border:2px solid red; border-radius:8px; padding:12px; margin-top:15px; color:red; font-weight:bold; font-size:15px; text-align:center;">
      ⏰ Si raccomanda di rispettare l'orario prescelto. Con un ritardo superiore ai 10 minuti l'appuntamento verrà considerato annullato.
    </div>

      <div id="alertObbligatorio">❌ Attenzione: tutti i campi sono obbligatori</div>
      <button type="button" id="prenota" onclick="invia()" disabled>Prenota</button>
    </form>
  </div>

  <div id="successOverlay">APPUNTAMENTO CONFERMATO! Riceverete una copia all'indirizzo email indicato!</div>

<script>
const altroCheck = document.getElementById('altroCheck');
const altroTesto = document.getElementById('altroTesto');

altroCheck.addEventListener('change', () => {
  if (altroCheck.checked) {
    altroTesto.style.display = 'block';
    altroTesto.focus();
  } else {
    altroTesto.style.display = 'none';
    altroTesto.value = '';
  }
});
  
const API_URL = 'https://script.google.com/macros/s/AKfycbwo7KNaTHkDrpbvK6u_uzYXlZgh-4VoizoTnGCijEcxFB4g_3T5zu29UWi7QSE2SICJqQ/exec';

let dateDisponibili = [];

async function init(){
  const loadingScreen = document.getElementById("loadingOverlay");
  const formWrapper = document.getElementById("formWrapper");
  
  // Caricamento finto di 5 secondi
  setTimeout(() => {
    loadingScreen.style.display = "none";
    formWrapper.style.display = "block";
  }, 5000);
  
  // Nel frattempo carica dati in background
  try {
    const response = await fetch(API_URL + '?action=getAllData');
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
       
    // Unisci e ordina le date
    const date1ora = data.date && data.date["1h"] ? data.date["1h"] : [];
    const date3ore = data.date && data.date["3h"] ? data.date["3h"] : [];
    
    dateDisponibili = unisciEOrdinaDate(date1ora, date3ore);
    
    console.log('Dati caricati:', Object.keys(dbTarghe).length, 'targhe');
    console.log('Date disponibili:', dateDisponibili.length);
    
    // Popola dropdown date
    popolaDateDropdown();
    
  } catch(error) {
    console.error('Errore caricamento dati:', error);
    alert('Errore nel caricamento dei dati. Riprova più tardi.');
    return;
  }

  // Imposta stato iniziale form
  document.getElementById("depositoContainer").classList.add("hidden");
  document.getElementById("campiAuto").classList.add("hidden");
  document.getElementById("campiContatti").classList.add("hidden");
  document.getElementById("msgDepNo").style.display = "none";
  aggiornaStatoPrenota();
}

function unisciEOrdinaDate(date1ora, date3ore) {
  const months = {
    "gennaio": 0, "febbraio": 1, "marzo": 2, "aprile": 3, "maggio": 4, "giugno": 5,
    "luglio": 6, "agosto": 7, "settembre": 8, "ottobre": 9, "novembre": 10, "dicembre": 11
  };

  function parseDateString(str) {
    if (!str) return null;
    const parts = str.toLowerCase().split(" ");
    const day = parseInt(parts[1]);
    const month = months[parts[2]];
    const now = new Date();
    const year = now.getFullYear();
    const [hours, minutes] = parts[3].split(":").map(Number);
    return new Date(year, month, day, hours, minutes);
  }

  const allDatesWithText = [];

  // Aggiungi date da 1 ora con prefisso
  date1ora.forEach(d => {
    const dateObj = parseDateString(d);
    if (dateObj) {
      allDatesWithText.push({
        date: dateObj,
        text: "1 ORA fermo auto: " + d
      });
    }
  });

  // Aggiungi date da 3 ore con prefisso
  date3ore.forEach(d => {
    const dateObj = parseDateString(d);
    if (dateObj) {
      allDatesWithText.push({
        date: dateObj,
        text: "3 ORE fermo auto: " + d
      });
    }
  });

  // Ordina per data
  allDatesWithText.sort((a, b) => a.date - b.date);

  // Estrai solo il testo
  return allDatesWithText.map(item => item.text);
}

function popolaDateDropdown() {
  const select = document.getElementById("dataAppuntamento");
  select.innerHTML = '<option value="">Seleziona...</option>';
  
  dateDisponibili.forEach(d => {
    const option = document.createElement("option");
    option.value = d;
    option.textContent = d;
    select.appendChild(option);
  });
}



function aggiornaStatoPrenota(){
  const btn = document.getElementById("prenota");
  const targaOk = targaValida;
  const dataOk = document.getElementById("dataAppuntamento").value.trim() !== "";
  const telOk = document.getElementById("telefono").value.trim() !== "";
  const emailOk = document.getElementById("email").value.trim() !== "";

  btn.disabled = !(targaOk && dataOk && telOk && emailOk);
  document.getElementById("alertObbligatorio").style.display = (targaOk && dataOk && telOk && emailOk) ? "none" : "block";
}

async function invia(){
  const btn = document.getElementById("prenota");
  btn.disabled = true;
  btn.textContent = "Invio in corso, attendere...";

  const dati = {
    tipologiacliente: document.querySelector('input[name="tipologiacliente"]:checked')?.value || "",
    dep: document.querySelector('input[name="dep"]:checked')?.value || "",
    targa: document.getElementById("targa").value.trim(),
    marcaModello: document.getElementById("marcaModello").value.trim(),
    nomeCognome: document.getElementById("nomeCognome").value.trim(),
    email: document.getElementById("email").value.trim(),
    telefono: document.getElementById("telefono").value.trim(),
    dataAppuntamento: document.getElementById("dataAppuntamento").value
  };

  console.log('Invio dati a:', API_URL);
  console.log('Dati:', dati);

  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'salvaPrenotazione', dati: dati })
  })
  .then(response => {
    console.log('Response status:', response.status);
    return response.json();
  })
  .then(result => {
    console.log('Risultato:', result);
  })
  .catch(error => {
    console.error('Errore (non bloccante):', error);
  });

  setTimeout(() => {
    document.getElementById("formWrapper").style.display="none";
    const overlay = document.getElementById("successOverlay");
    overlay.style.display="block";
    overlay.scrollIntoView({behavior:"smooth", block:"center"});
  }, 3000);
}
</script>
</body>
</html>
